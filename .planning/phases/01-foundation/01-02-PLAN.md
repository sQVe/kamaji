---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified:
    - internal/domain/sprint.go
    - internal/domain/state.go
    - internal/domain/ticketlog.go
    - internal/config/sprint.go
    - internal/config/state.go
    - internal/config/ticketlog.go
    - internal/domain/sprint_test.go
    - internal/domain/state_test.go
    - internal/config/sprint_test.go
    - internal/config/state_test.go
    - internal/config/ticketlog_test.go
---

<objective>
YAML config parsing for kamaji.yaml (sprint definition) and .kamaji/state.yaml (runtime state).

Purpose: Enable Kamaji to read sprint configurations and persist runtime state.
Output: Domain types and config I/O functions with full test coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DESIGN.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Reference patterns from stash:**

- `git show stash@{0}:internal/domain/sprint.go` - Sprint, Ticket, Task types
- `git show stash@{0}:internal/domain/state.go` - State type
- `git show stash@{0}:internal/config/sprint.go` - LoadSprint with validation
- `git show stash@{0}:internal/config/state.go` - LoadState, SaveState
- `git show stash@{0}:internal/config/ticketlog.go` - TicketLog I/O

**Schemas from DESIGN.md:**

kamaji.yaml:

```yaml
name: "Sprint name"
base_branch: main
rules:
    - "Use TypeScript strict mode"
tickets:
    - name: login-form
      branch: feat/login-form
      description: "Create login form"
      tasks:
          - description: "Create component"
            steps:
                - "Add validation"
            verify: "Component renders"
```

.kamaji/state.yaml:

```yaml
current_ticket: 0
current_task: 0
failure_count: 0
```

.kamaji/logs/<ticket>.yaml:

```yaml
ticket: login-form
completed:
    - task: "Create component"
      summary: "Created LoginForm.tsx"
failed_attempts:
    - task: "Add OAuth"
      summary: "Conflicts with middleware"
insights:
    - "Uses Zustand for state"
```

**Package architecture:**

- internal/domain/ — Pure data types (no I/O)
- internal/config/ — File I/O and persistence
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain types with tests</name>
  <files>internal/domain/sprint.go, internal/domain/state.go, internal/domain/ticketlog.go, internal/domain/sprint_test.go, internal/domain/state_test.go</files>
  <action>
**TDD: Write tests first.**

Create domain types (pure data, no I/O):

Sprint types (sprint.go):

- Sprint: Name, BaseBranch, Rules []string, Tickets []Ticket
- Ticket: Name, Branch, Description, Tasks []Task
- Task: Description, Steps []string, Verify

State type (state.go):

- State: CurrentTicket, CurrentTask, FailureCount (all int)

TicketLog types (ticketlog.go):

- TicketLog: Ticket string, Completed []CompletedTask, FailedAttempts []FailedAttempt, Insights []string
- CompletedTask: Task, Summary string
- FailedAttempt: Task, Summary string

All fields use yaml struct tags matching DESIGN.md schemas.

Tests verify:

- YAML marshaling/unmarshaling roundtrips
- Zero values are correct
- Struct tags are correct

Reference: `git show stash@{0}:internal/domain/sprint.go` etc.
</action>
<verify>go test ./internal/domain/...</verify>
<done>All domain types defined, tests pass, YAML roundtrip works</done>
</task>

<task type="auto">
  <name>Task 2: Create config I/O functions with tests</name>
  <files>internal/config/sprint.go, internal/config/state.go, internal/config/ticketlog.go, internal/config/sprint_test.go, internal/config/state_test.go, internal/config/ticketlog_test.go</files>
  <action>
**TDD: Write tests first.**

Config package handles file I/O:

sprint.go:

- LoadSprint(path string) (\*domain.Sprint, error)
- validateSprint checks: name required, each ticket.name required, each task.description required
- Clear error messages with context (indices, field names)

state.go:

- LoadState(dir string) (\*domain.State, error) - reads .kamaji/state.yaml, returns zero State if missing
- SaveState(dir string, state \*domain.State) error - creates .kamaji/ if needed

ticketlog.go:

- LoadTicketLog(dir, ticketName string) (\*domain.TicketLog, error) - reads .kamaji/logs/<ticket>.yaml
- SaveTicketLog(dir string, log \*domain.TicketLog) error - sanitizes "/" in ticket name to "-"

Error handling:

- Missing state file → return zero-value State (not error)
- Missing ticket log → return zero-value TicketLog (not error)
- Invalid YAML → return wrapped error with context

Tests use t.TempDir() for isolation. Test cases:

- Valid YAML roundtrip
- Missing file behavior
- Validation errors
- Directory creation

Reference: `git show stash@{0}:internal/config/sprint.go` etc.
</action>
<verify>go test ./internal/config/...</verify>
<done>All config functions work, tests pass, validation catches bad input</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./internal/domain/...` passes
- [ ] `go test ./internal/config/...` passes
- [ ] `make test` passes
- [ ] `make lint` passes
- [ ] Missing state file returns zero-value (not error)
- [ ] Invalid YAML returns descriptive error
</verification>

<success_criteria>

- All tasks completed
- Domain types match DESIGN.md schemas
- Config I/O handles edge cases (missing files, validation)
- Tests cover happy path and error cases
- No linter errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
