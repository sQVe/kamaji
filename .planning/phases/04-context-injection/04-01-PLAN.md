---
phase: 04-context-injection
plan: 01
type: tdd
depends_on: []
files_modified: [internal/prompt/prompt.go, internal/prompt/prompt_test.go]
---

<objective>
Create BuildPrompt function that generates XML prompt structure.

Purpose: Transform task info, rules, and history into XML format for Claude Code injection.
Output: Working, tested BuildPrompt function matching DESIGN.md spec.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DESIGN.md (lines 165-210 for XML format)
@internal/statemachine/statemachine.go (TaskInfo struct)
@internal/domain/history.go (TicketHistory types)
</context>

<feature>
  <name>BuildPrompt XML generator</name>
  <files>internal/prompt/prompt.go, internal/prompt/prompt_test.go</files>
  <behavior>
    BuildPrompt(taskInfo *statemachine.TaskInfo, rules []string, history *domain.TicketHistory) string

    Cases:
    - Full data → complete XML with all sections
    - Empty history (nil or zero values) → omits completed/failed_attempts/insights sections
    - Empty steps (nil or empty slice) → omits steps section
    - Empty verify (empty string) → omits verify section
    - XML-unsafe characters (<, >, &, etc.) → escaped properly
    - Nil taskInfo → returns empty string (edge case)

    Output format (DESIGN.md:165-210):
    ```xml
    <task>
    <ticket name="..." branch="...">
    [ticket description]
    </ticket>

    <current>
    [task description]
    </current>

    <steps>
    - [step 1]
    - [step 2]
    </steps>

    <verify>
    [verification criteria]
    </verify>
    </task>

    <rules>
    [rule 1]
    [rule 2]
    </rules>

    <history>
    <completed>
    - [task]: [summary]
    </completed>

    <failed_attempts>
    - [task]: [summary]
    </failed_attempts>

    <insights>
    - [insight 1]
    </insights>
    </history>

    <instructions>
    Complete the task. Call task_complete(pass/fail, summary) when done.
    Use note_insight() to record discoveries useful for future tasks.
    </instructions>
    ```

  </behavior>
  <implementation>
    Use strings.Builder for efficient string concatenation.
    Use html.EscapeString for XML-safe content.
    Conditional section building based on non-empty checks.
    Static instructions text (same for all tasks).
  </implementation>
</feature>

<verification>
- [ ] `go test ./internal/prompt/...` passes
- [ ] Output matches DESIGN.md XML format exactly
- [ ] Empty sections omitted cleanly (no empty tags)
- [ ] XML-unsafe characters properly escaped
</verification>

<success_criteria>

- Failing test written and committed
- Implementation passes test
- Refactor complete (if needed)
- All 2-3 commits present
- BuildPrompt output matches DESIGN.md format
  </success_criteria>

<output>
After completion, create `.planning/phases/04-context-injection/04-01-SUMMARY.md`:

# Phase 04 Plan 01: BuildPrompt XML generator Summary

**[Substantive one-liner]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DD
- **Completed:** YYYY-MM-DD

## TDD Cycles

### BuildPrompt

- **RED:** [What test was written, why it failed]
- **GREEN:** [What implementation made it pass]
- **REFACTOR:** [What cleanup was done, if any]

## Task Commits

[List commits with hashes]

## Files Created/Modified

- `internal/prompt/prompt.go` - BuildPrompt function
- `internal/prompt/prompt_test.go` - Unit tests

## Decisions Made

[Key decisions and rationale]

## Deviations from Plan

[Any deviations, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md (context assembly)
</output>
