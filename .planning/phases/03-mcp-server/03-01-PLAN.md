---
phase: 03-mcp-server
plan: 01
type: tdd
depends_on: []
files_modified:
    [go.mod, go.sum, internal/mcp/server.go, internal/mcp/server_test.go]
---

<objective>
Create MCP server infrastructure with Streamable HTTP transport.

Purpose: Enable Claude Code to connect and call tools via MCP protocol.
Output: Server struct with Start/Shutdown lifecycle, exposing /mcp endpoint.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DESIGN.md
@go.mod

**Library choice:** github.com/mark3labs/mcp-go (mature Go MCP SDK)

- Supports Streamable HTTP transport (protocol 2025-11-25)
- `server.NewMCPServer()` for MCP server setup
- `server.NewStreamableHTTPServer()` for HTTP transport
- Typed tool handlers with `mcp.NewTypedToolHandler()`

**From DESIGN.md:**

- Transport: Streamable HTTP on localhost:<port>/mcp
- Port: Dynamically assigned or configurable via --port
- Claude Code connects with `--mcp-config` pointing to temp file

**Dependencies from Phase 1:**

- Cobra CLI exists (cmd/kamaji/main.go)
- Config parsing exists (internal/config/)

**Dependencies from Phase 2:**

- State machine exists (internal/statemachine/)
- RecordPass, RecordFail, IsStuck functions available
  </context>

<feature>
  <name>MCP Server with Streamable HTTP transport</name>
  <files>internal/mcp/server.go, internal/mcp/server_test.go</files>
  <behavior>
    Server struct wraps mcp-go server with lifecycle management.

    NewServer(opts ...Option) *Server:
    - Creates MCPServer with name "kamaji" and version from internal/version
    - Stores port configuration (default 0 for dynamic assignment)

    Server.Start() (int, error):
    - Creates StreamableHTTPServer
    - Starts on configured port (0 = dynamic)
    - Returns actual port assigned
    - Returns error if start fails

    Server.Shutdown(ctx context.Context) error:
    - Gracefully shuts down HTTP server
    - Returns error if shutdown fails

    Server.Port() int:
    - Returns the port the server is listening on
    - Returns 0 if not started

    Cases:
    - NewServer() with no options uses port 0
    - NewServer(WithPort(8080)) uses port 8080
    - Start() on port 0 returns dynamically assigned port
    - Start() twice returns error
    - Shutdown() before Start() is a no-op
    - Port() returns 0 before Start(), actual port after

  </behavior>
  <implementation>
    Use mcp-go's server.NewMCPServer and server.NewStreamableHTTPServer.
    Wrap in custom Server struct for lifecycle management.
    Use net.Listen("tcp", ":0") pattern for dynamic port assignment.
    Store actual port after successful start.
  </implementation>
</feature>

<verification>
- `go mod tidy` succeeds (mcp-go installed)
- `go test ./internal/mcp/...` passes
- `make test` passes (all unit tests)
- `make lint` passes
</verification>

<success_criteria>

- RED: Failing tests written for Server lifecycle
- GREEN: All tests pass with minimal implementation
- REFACTOR: Code cleaned up (if needed)
- mcp-go dependency added to go.mod
- Server can start on dynamic port and shut down cleanly
- All commits follow TDD pattern
  </success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-server/03-01-SUMMARY.md`:

# Plan 03-01 Summary: MCP server infrastructure

**[One-liner about what shipped]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DD
- **Completed:** YYYY-MM-DD

## TDD Cycles

### Server lifecycle

- RED: [test description, why it failed]
- GREEN: [implementation approach]
- REFACTOR: [cleanup if any]

## Files Created/Modified

- `go.mod` - Added mcp-go dependency
- `internal/mcp/server.go` - Server struct with lifecycle
- `internal/mcp/server_test.go` - Unit tests

## Commits

| Commit | Description                                         |
| ------ | --------------------------------------------------- |
| ...    | chore: add mcp-go dependency                        |
| ...    | test(03-01): add failing tests for Server lifecycle |
| ...    | feat(03-01): implement Server with Streamable HTTP  |

## Next Step

Ready for 03-02-PLAN.md (tool handlers)
</output>
