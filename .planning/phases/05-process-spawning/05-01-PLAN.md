---
phase: 05-process-spawning
plan: 01
type: tdd
depends_on: []
files_modified:
    [
        internal/mcp/server.go,
        internal/mcp/tools.go,
        internal/mcp/server_test.go,
        internal/mcp/tools_test.go,
    ]
---

<objective>
Add signal channel to MCP server for tool call events.

Purpose: Enable orchestrator to receive notifications when Claude calls task_complete or note_insight, allowing coordination between process management and task state updates.
Output: Server with Signals() channel, Signal struct, tool handlers emitting signals.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-mcp-server/03-01-SUMMARY.md
@.planning/phases/03-mcp-server/03-02-SUMMARY.md
@internal/mcp/server.go
@internal/mcp/tools.go
</context>

<feature>
  <name>MCP Server Signal Channel</name>
  <files>internal/mcp/server.go, internal/mcp/tools.go, internal/mcp/server_test.go, internal/mcp/tools_test.go</files>
  <behavior>
    Signal struct holds tool call data:
    - Tool: "task_complete" | "note_insight"
    - Status: "pass" | "fail" (only for task_complete)
    - Summary: string (task_complete summary or note_insight text)

    Server behavior:
    - NewServer() creates buffered signal channel (capacity 10)
    - Signals() returns receive-only channel
    - When task_complete called: emit Signal{Tool:"task_complete", Status:args.Status, Summary:args.Summary}
    - When note_insight called: emit Signal{Tool:"note_insight", Summary:args.Text}
    - Non-blocking send (drop if channel full - orchestrator should be listening)

    Test cases:
    - Signal struct fields correct for task_complete pass
    - Signal struct fields correct for task_complete fail
    - Signal struct fields correct for note_insight
    - Signals() returns channel
    - Multiple signals can be received in order

  </behavior>
  <implementation>
    1. Add Signal struct to tools.go
    2. Add signals chan Signal field to Server struct
    3. Initialize channel in NewServer (buffered, cap 10)
    4. Add Signals() method returning <-chan Signal
    5. Modify HandleTaskComplete to accept *Server receiver or use closure pattern
    6. Modify HandleNoteInsight similarly
    7. Emit signal in each handler before returning result

    Note: mcp-go uses typed handlers with signature func(ctx, req, args). To access Server, either:
    - Use closure: wrap handler in method that captures *Server
    - Or store channel in context (less clean)
    Prefer closure pattern for simplicity.

  </implementation>
</feature>

<verification>
go test -v ./internal/mcp/... -run Signal
</verification>

<success_criteria>

- Signal struct defined with Tool, Status, Summary fields
- Server has Signals() method returning <-chan Signal
- task_complete handler emits signal with correct data
- note_insight handler emits signal with correct data
- All existing tests still pass
- 2-3 commits: test(05-01), feat(05-01), optional refactor(05-01)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-process-spawning/05-01-SUMMARY.md`:

# Phase 05 Plan 01: MCP Server Signal Channel Summary

**[One-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DD
- **Completed:** YYYY-MM-DD

## TDD Cycles

### Signal channel

- **RED:** [What test was written, why it failed]
- **GREEN:** [What implementation made it pass]
- **REFACTOR:** [What cleanup was done, if any]

## Files Created/Modified

- `internal/mcp/server.go` - Added signals channel, Signals() method
- `internal/mcp/tools.go` - Added Signal struct, modified handlers to emit signals
- `internal/mcp/server_test.go` - Signal channel tests
- `internal/mcp/tools_test.go` - Handler signal emission tests

## Commits

| Commit | Description                                        |
| ------ | -------------------------------------------------- |
| ...    | test(05-01): add failing tests for signal channel  |
| ...    | feat(05-01): implement signal channel and emission |

## Next Step

Ready for 05-02-PLAN.md (Claude process manager)
</output>
