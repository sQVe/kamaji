---
phase: 06-git-operations
plan: 02
type: tdd
depends_on: ["06-01"]
files_modified: [internal/git/git.go, internal/git/git_test.go]
---

<objective>
Implement git commit and reset operations for task pass/fail handling.

Purpose: Enable orchestrator to commit on pass and reset on fail.
Output: CommitChanges and ResetToHead functions with comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/tdd.md
./06-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-git-operations/06-01-SUMMARY.md
@internal/git/git.go

**From DESIGN.md - Git handling:**

- On pass: Orchestrator commits with task summary as message
- On fail: `git reset --hard HEAD` (clean slate for retry)

**From DESIGN.md - Execution flow step 9:**

```
9. Wait for signal:
   a. task_complete(pass) -> commit changes, store summary, next task
   b. task_complete(fail) -> reset to HEAD, increment failures, store attempt, retry or stuck
```

**Constraints:**

- CommitChanges stages all changes (`git add -A`) then commits
- ResetToHead uses `--hard` to discard all changes
- Both functions reuse runGit helper from 06-01
  </context>

<feature>
  <name>CommitChanges and ResetToHead - Task completion git operations</name>
  <files>internal/git/git.go, internal/git/git_test.go</files>
  <behavior>
    CommitChanges(workDir, message string) error
    - Stages all changes with `git add -A`
    - Commits with provided message
    - Returns nil on success
    - Returns error if nothing to commit (empty staging area)
    - Returns error if not a git repo

    ResetToHead(workDir string) error
    - Runs `git reset --hard HEAD`
    - Returns nil on success (even if no changes to reset)
    - Returns error if not a git repo

    Cases for CommitChanges:
    - Has changes: Stages and commits -> success, returns nil
    - No changes: Returns error "nothing to commit"
    - Bad message (empty): Returns error "commit message required"
    - Not a repo: Returns error with git stderr

    Cases for ResetToHead:
    - Has changes: Discards all changes -> success
    - No changes: Still succeeds (idempotent)
    - Not a repo: Returns error

  </behavior>
  <implementation>
    CommitChanges:
    1. Validate message non-empty
    2. runGit(workDir, "add", "-A")
    3. runGit(workDir, "diff", "--cached", "--quiet") - check if staged
       - Exit 0 = nothing staged -> return "nothing to commit" error
       - Exit 1 = has staged changes -> continue
    4. runGit(workDir, "commit", "-m", message)
    5. Return nil

    ResetToHead:
    1. runGit(workDir, "reset", "--hard", "HEAD")
    2. Return nil on success, wrap error on failure

  </implementation>
</feature>

<verification>
go test -v ./internal/git/...
</verification>

<success_criteria>

- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor if needed
- Tests cover: commit success, nothing to commit, empty message, reset success, reset idempotent
- Tests use real git commands in temp directories
  </success_criteria>

<output>
After completion, create `.planning/phases/06-git-operations/06-02-SUMMARY.md`:

# Plan 06-02 Summary: Commit and Reset Operations

**[One-liner: what shipped]**

## TDD Cycles

### CommitChanges

- **RED:** [What tests, why failed]
- **GREEN:** [Implementation]
- **REFACTOR:** [Cleanup]

### ResetToHead

- **RED:** [What tests, why failed]
- **GREEN:** [Implementation]
- **REFACTOR:** [Cleanup]

## Task Commits

- `[hash]` test(06-02): add failing tests for CommitChanges and ResetToHead
- `[hash]` feat(06-02): implement CommitChanges and ResetToHead

## Files Created/Modified

- `internal/git/git.go` - Added CommitChanges, ResetToHead
- `internal/git/git_test.go` - Added tests

## Decisions Made

[Key decisions]

## Next Step

Phase 6 complete, ready for Phase 7: Ticket Logging
</output>
