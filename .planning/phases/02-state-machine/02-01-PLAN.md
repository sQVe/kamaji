---
phase: 02-state-machine
plan: 01
type: tdd
depends_on: []
files_modified:
    [
        internal/statemachine/statemachine.go,
        internal/statemachine/statemachine_test.go,
    ]
---

<objective>
Implement state machine types and core navigation logic using TDD.

Purpose: Enable the orchestrator to determine which task to execute next and advance through the sprint.
Output: `TaskInfo` type, `NextTask` function, and `Advance` function with comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DESIGN.md
@internal/domain/state.go
@internal/domain/sprint.go

**From Phase 1:**

- Domain types exist: `State`, `Sprint`, `Ticket`, `Task`
- Config I/O exists: `LoadState`, `SaveState` in `internal/config/`
- Test infrastructure: unit tests with `go test`, integration with testscript

**DESIGN.md specification:**

```go
NextTask(sprint, state) *TaskInfo  // Returns nil at end, skips empty tickets
Advance(state, sprint)             // Increments task, handles ticket boundaries
```

`TaskInfo` contains both domain objects and indices for orchestration context.
</context>

<feature>
  <name>TaskInfo type and NextTask function</name>
  <files>internal/statemachine/statemachine.go, internal/statemachine/statemachine_test.go</files>
  <behavior>
    TaskInfo struct contains:
    - TicketIndex, TaskIndex (int)
    - Ticket (*domain.Ticket)
    - Task (*domain.Task)

    NextTask(sprint *domain.Sprint, state *domain.State) *TaskInfo:
    - Returns TaskInfo for current position when valid
    - Returns nil when all tickets complete (current_ticket >= len(tickets))
    - Returns nil when current ticket has no tasks (edge case)
    - Skips empty tickets (tickets with zero tasks)
    - Handles out-of-bounds task index gracefully

    Cases:
    - Sprint with 2 tickets, 2 tasks each, state at (0,0) → TaskInfo{0, 0, ticket0, task0}
    - Sprint with 2 tickets, state at (0,1) → TaskInfo{0, 1, ticket0, task1}
    - Sprint with 2 tickets, state at (2,0) → nil (past end)
    - Sprint with empty first ticket, state at (0,0) → nil or skip to next
    - Empty sprint → nil

  </behavior>
  <implementation>
    Create internal/statemachine/ package.
    TaskInfo is a struct with pointers to domain objects (not copies).
    NextTask validates indices before accessing arrays.
    Use early returns for edge cases.
  </implementation>
</feature>

<feature>
  <name>Advance function</name>
  <files>internal/statemachine/statemachine.go, internal/statemachine/statemachine_test.go</files>
  <behavior>
    Advance(state *domain.State, sprint *domain.Sprint):
    - Increments current_task
    - When current_task reaches end of ticket's tasks, increments current_ticket and resets current_task to 0
    - Does NOT wrap around (stops at end)
    - Mutates state in place

    Cases:
    - State (0,0), ticket has 3 tasks → State (0,1)
    - State (0,2), ticket has 3 tasks → State (1,0)
    - State (1,0), only 2 tickets → State (2,0) (past end, NextTask returns nil)
    - Empty sprint → no-op or safe handling

  </behavior>
  <implementation>
    Advance modifies state pointer directly.
    Check bounds before incrementing.
    Caller uses NextTask to detect completion.
  </implementation>
</feature>

<verification>
- `go test ./internal/statemachine/...` passes
- `make test` passes (all unit tests)
- `make lint` passes
</verification>

<success_criteria>

- RED: Failing tests written for TaskInfo, NextTask, Advance
- GREEN: All tests pass with minimal implementation
- REFACTOR: Code cleaned up (if needed)
- All commits follow TDD pattern (test → feat → refactor)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-state-machine/02-01-SUMMARY.md`:

# Plan 02-01 Summary: State machine types and core navigation

## Status: Complete

## TDD Cycles

### TaskInfo + NextTask

- RED: [test description, why it failed]
- GREEN: [implementation approach]
- REFACTOR: [cleanup if any]

### Advance

- RED: [test description, why it failed]
- GREEN: [implementation approach]
- REFACTOR: [cleanup if any]

## Files Created/Modified

- `internal/statemachine/statemachine.go` - TaskInfo, NextTask, Advance
- `internal/statemachine/statemachine_test.go` - Comprehensive tests

## Commits

| Commit | Description                                              |
| ------ | -------------------------------------------------------- |
| ...    | test(02-01): add failing tests for TaskInfo and NextTask |
| ...    | feat(02-01): implement TaskInfo and NextTask             |
| ...    | test(02-01): add failing tests for Advance               |
| ...    | feat(02-01): implement Advance                           |

## Next Step

Ready for 02-02-PLAN.md (pass/fail handling)
</output>
