---
phase: 02-state-machine
plan: 02
type: tdd
depends_on: ["02-01"]
files_modified:
    [
        internal/statemachine/statemachine.go,
        internal/statemachine/statemachine_test.go,
    ]
---

<objective>
Implement pass/fail handling logic using TDD.

Purpose: Enable the orchestrator to record task outcomes and detect when execution is stuck.
Output: `RecordPass`, `RecordFail`, and `IsStuck` functions with comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DESIGN.md
@internal/domain/state.go
@internal/domain/sprint.go
@.planning/phases/02-state-machine/02-01-SUMMARY.md

**From 02-01:**

- `TaskInfo` type exists
- `NextTask` and `Advance` functions exist
- State machine package at `internal/statemachine/`

**DESIGN.md specification:**

```go
RecordPass(state, sprint)          // Resets failure_count, calls Advance
RecordFail(state)                  // Increments failure_count
IsStuck(state) bool                // Returns failure_count >= 3
```

**Failure handling rules from DESIGN.md:**

- Failure count: Consecutive failures on current task (resets to 0 on pass)
- Stuck threshold: 3 consecutive failures on the same task
  </context>

<feature>
  <name>RecordPass and RecordFail functions</name>
  <files>internal/statemachine/statemachine.go, internal/statemachine/statemachine_test.go</files>
  <behavior>
    RecordPass(state *domain.State, sprint *domain.Sprint):
    - Sets failure_count to 0
    - Calls Advance(state, sprint)
    - Mutates state in place

    RecordFail(state *domain.State):
    - Increments failure_count by 1
    - Does NOT advance (stays on same task for retry)
    - Mutates state in place

    Cases for RecordPass:
    - State (0,0) with failure_count=2 → State (0,1) with failure_count=0
    - State (0,2) last task in ticket → State (1,0) with failure_count=0

    Cases for RecordFail:
    - State with failure_count=0 → failure_count=1
    - State with failure_count=2 → failure_count=3
    - Position unchanged after fail

  </behavior>
  <implementation>
    RecordPass resets then delegates to Advance.
    RecordFail is a simple increment.
    Both modify state pointer directly.
  </implementation>
</feature>

<feature>
  <name>IsStuck function</name>
  <files>internal/statemachine/statemachine.go, internal/statemachine/statemachine_test.go</files>
  <behavior>
    IsStuck(state *domain.State) bool:
    - Returns true when failure_count >= 3
    - Returns false otherwise

    Cases:
    - failure_count=0 → false
    - failure_count=2 → false
    - failure_count=3 → true
    - failure_count=5 → true

  </behavior>
  <implementation>
    Simple comparison: return state.FailureCount >= 3
    Threshold is hardcoded per DESIGN.md spec.
  </implementation>
</feature>

<verification>
- `go test ./internal/statemachine/...` passes
- `make test` passes (all unit tests)
- `make lint` passes
</verification>

<success_criteria>

- RED: Failing tests written for RecordPass, RecordFail, IsStuck
- GREEN: All tests pass with minimal implementation
- REFACTOR: Code cleaned up (if needed)
- All commits follow TDD pattern (test → feat → refactor)
- Phase 2 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/02-state-machine/02-02-SUMMARY.md`:

# Plan 02-02 Summary: Pass/fail handling

## Status: Complete

## TDD Cycles

### RecordPass + RecordFail

- RED: [test description, why it failed]
- GREEN: [implementation approach]
- REFACTOR: [cleanup if any]

### IsStuck

- RED: [test description, why it failed]
- GREEN: [implementation approach]
- REFACTOR: [cleanup if any]

## Files Created/Modified

- `internal/statemachine/statemachine.go` - RecordPass, RecordFail, IsStuck
- `internal/statemachine/statemachine_test.go` - Additional tests

## Commits

| Commit | Description                                                  |
| ------ | ------------------------------------------------------------ |
| ...    | test(02-02): add failing tests for RecordPass and RecordFail |
| ...    | feat(02-02): implement RecordPass and RecordFail             |
| ...    | test(02-02): add failing tests for IsStuck                   |
| ...    | feat(02-02): implement IsStuck                               |

## Phase 2 Status

Phase 2 (State Machine) complete with all 2 plans finished:

- 02-01: State machine types and core navigation
- 02-02: Pass/fail handling

## Next Step

Phase complete, ready for Phase 3 (MCP Server)
</output>
