---
phase: 07-ticket-logging
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [internal/config/history.go, internal/config/history_test.go]
---

<objective>
Add query functions for listing ticket histories and generating summary statistics.

Purpose: Enable reporting and debugging of sprint progress across tickets.
Output: Query and summary functions in config package with tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ticket-logging/07-01-SUMMARY.md

**Existing infrastructure:**
@internal/domain/history.go
@internal/config/history.go

**Key patterns:**

- History files stored in .kamaji/history/<ticket>.yaml
- sanitizeFilename used for ticket name â†’ filename conversion
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add ListTicketHistories function</name>
  <files>internal/config/history.go, internal/config/history_test.go</files>
  <action>
Add function to internal/config/history.go:

```go
// ListTicketHistories returns all ticket histories from .kamaji/history/.
// Returns empty slice if directory doesn't exist.
func ListTicketHistories(dir string) ([]*domain.TicketHistory, error)
```

Implementation:

1. Read .kamaji/history/ directory (return empty slice if not exists)
2. For each .yaml file, call LoadTicketHistory
3. Return slice of all loaded histories

Add tests covering:

- Empty directory (returns empty slice)
- Directory with multiple history files
- Directory doesn't exist (returns empty slice, not error)
- Handles non-.yaml files gracefully (ignores them)
  </action>
  <verify>go test -v ./internal/config/... -run "ListTicketHistories" passes</verify>
  <done>ListTicketHistories function exists with tests passing</done>
  </task>

<task type="auto">
  <name>Task 2: Add HistorySummary type and GetHistorySummary function</name>
  <files>internal/config/history.go, internal/config/history_test.go</files>
  <action>
Add to internal/config/history.go:

```go
// HistorySummary provides aggregate statistics for ticket history.
type HistorySummary struct {
    TotalCompleted    int
    TotalFailed       int
    TotalInsights     int
    TicketCount       int
}

// GetHistorySummary returns aggregate statistics for a single history.
func GetHistorySummary(history *domain.TicketHistory) HistorySummary

// GetAllHistoriesSummary returns aggregate statistics across all histories.
func GetAllHistoriesSummary(histories []*domain.TicketHistory) HistorySummary
```

GetHistorySummary: counts from single history (TicketCount=1)
GetAllHistoriesSummary: sums across all histories

Add tests covering:

- Single history with mixed data
- Empty history (all zeros)
- Multiple histories aggregated correctly
- Nil/empty slice handling
  </action>
  <verify>go test -v ./internal/config/... -run "HistorySummary" passes</verify>
  <done>HistorySummary type and both summary functions exist with tests passing</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./internal/config/...` passes all tests
- [ ] `make lint` passes
- [ ] ListTicketHistories works correctly
- [ ] GetHistorySummary and GetAllHistoriesSummary produce correct aggregates
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Query functions handle edge cases (empty, missing directory)
- Summary functions produce accurate aggregates
- Phase 7 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/07-ticket-logging/07-02-SUMMARY.md`
</output>
